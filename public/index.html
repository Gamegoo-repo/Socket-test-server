<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Socket 서버 테스트</title>
    <style>
      body,
      html {
        margin: 0;
        padding: 0;
        height: 100%;
        font-family: Arial, sans-serif;
      }

      .container {
        display: flex;
        flex-direction: column;
        height: 100vh; /* 100% of the viewport height */
      }

      .top-bar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        background-color: #333;
        color: white;
        padding: 10px;
      }

      .top-bar input,
      .top-bar button,
      .top-bar p {
        margin: 0 10px;
      }

      .content {
        display: flex;
        flex: 1;
        overflow: hidden; /* Prevent scrolling in the content area */
      }

      .column {
        flex: 1;
        padding: 20px;
        border: 1px solid #ddd;
        display: flex;
        flex-direction: column;
        overflow-y: auto;
      }

      .column:nth-child(odd) {
        background-color: #f9f9f9;
      }

      .column:nth-child(even) {
        background-color: #e9e9e9;
      }

      .chatroom {
        display: flex;
        flex-direction: column;
        height: 100%;
        box-sizing: border-box;
        overflow: hidden; /* Prevent scrolling in the chatroom area */
      }

      .messages {
        flex: 1;
        overflow-y: auto; /* Enable scrolling in the messages area */
      }

      .chat-form {
        display: flex;
      }

      .chat-form input {
        flex: 1;
      }

      .chatroom-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        border-bottom: 1px solid #ddd;
      }

      .chatroom-item img {
        border-radius: 50%;
      }

      .chatroom-info {
        flex: 1;
        margin-left: 10px;
      }

      .chatroom-info p {
        margin: 0;
      }

      .message-item {
        display: flex;
        align-items: flex-start;
        margin-bottom: 10px;
      }

      .message-item.mine {
        justify-content: flex-end;
      }

      .message-content {
        display: flex;
        align-items: center;
      }

      .sender-name {
        font-weight: bold;
        margin-bottom: 5px;
      }

      .message-text {
        margin: 0 10px;
      }

      .message-time {
        font-size: 0.8em;
        color: gray;
      }
      .online {
        color: red;
        font-size: 14px; /* 텍스트 크기 */
        font-weight: 300; /* 굵기 (400이 기본값, 더 얇게 하려면 숫자를 낮추세요) */
        font-style: italic; /* 이탤릭체 */
        padding-left: 5px; /* 왼쪽 여백 */
      }

      .offline {
        color: gray;
        font-size: 14px; /* 텍스트 크기 */
        font-weight: 300; /* 굵기 (400이 기본값, 더 얇게 하려면 숫자를 낮추세요) */
        font-style: italic; /* 이탤릭체 */
        padding-left: 5px; /* 왼쪽 여백 */
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="top-bar">
        <div>
          <input id="userId" type="number" placeholder="Enter your ID" />
          <button id="loginButton">Login</button>
          <button id="logoutButton">Logout</button>
        </div>
        <p id="loginStatus">You are not Login User</p>
      </div>
      <div class="content">
        <div class="column">
          <h2>친구 목록</h2>
          <ul id="onlineFriends"></ul>
        </div>
        <div class="column">
          <h2>채팅방 목록</h2>
          <ul id="chatroomList"></ul>
          <button id="fetchChatroomsButton">채팅방 목록 페이지 입장</button>
        </div>
        <div class="column chatroom">
          <h2>채팅방</h2>
          <ul id="messages" class="messages"></ul>
          <form id="form" class="chat-form" action="">
            <input id="input" autocomplete="off" />
            <button>Send</button>
          </form>
        </div>
      </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      let socket;
      const form = document.getElementById("form");
      const input = document.getElementById("input");
      const userIdInput = document.getElementById("userId");
      const loginButton = document.getElementById("loginButton");
      const logoutButton = document.getElementById("logoutButton");
      const onlineFriends = document.getElementById("onlineFriends");
      const loginStatus = document.getElementById("loginStatus");
      const fetchChatroomBtn = document.getElementById("fetchChatroomsButton");

      let memberId = null;
      let onlineFriendMemberIdList = [];
      let currentViewingChatroomUuid = null;
      let currentChattingMemberId = null;

      function connectSocket(jwtToken = null) {
        const options = jwtToken ? { auth: { token: jwtToken } } : {};

        socket = io(options);

        socket.on("connect", () => {
          console.log("Connected to server. Socket ID:", socket.id);
          alert("Connected to server. Socket ID: " + socket.id);
        });

        setupSocketListeners();
      }

      function setupSocketListeners() {
        form.addEventListener("submit", (e) => {
          e.preventDefault();
          if (input.value) {
            const msg = input.value;
            // 메시지를 보낼 때 room 이름과 메시지를 함께 전송
            socket.emit("chat-message", { uuid: currentViewingChatroomUuid, message: msg });
            input.value = "";

            // 내가 보낸 메시지 요소 생성
            const messagesElement = document.getElementById("messages");
            const shouldScrollToBottom = messagesElement.scrollTop === messagesElement.scrollHeight - messagesElement.clientHeight;
            const li = document.createElement("li");
            li.classList.add("message-item");
            li.classList.add("mine");
            li.innerHTML = `
                                    <div class="message-content">
                                      <img src="${localStorage.getItem("profileImg")}" alt="Profile Image" width="30" height="30">
                                      <div>
                                        <p class="sender-name">${localStorage.getItem("name")}</p>
                                        <p class="message-text">${msg}</p>
                                        <p class="message-time">${new Date().toLocaleString()}</p>
                                      </div>
                                    </div>
                                  `;
            messagesElement.appendChild(li);

            // Scroll to bottom if was already at bottom before fetching new messages or on initial load
            if (shouldScrollToBottom || messagesElement.children.length === 0) {
              //messagesElement.scrollTop = messagesElement.scrollHeight;
              setTimeout(() => {
                messagesElement.scrollTop = messagesElement.scrollHeight;
              }, 0);
            }
          }
        });

        // chat-message event listener
        socket.on("chat-message", (response) => {
          // 메시지가 온 채팅방이 현재 보고있는 채팅방이라면, 채팅 메세지 동적 생성
          if (response.data.chatroomUuid === currentViewingChatroomUuid) {
            const messagesElement = document.getElementById("messages");
            const shouldScrollToBottom = messagesElement.scrollTop === messagesElement.scrollHeight - messagesElement.clientHeight;
            const li = document.createElement("li");
            li.classList.add("message-item");
            if (response.data.senderId === memberId) {
              li.classList.add("mine");
            }
            li.innerHTML = `
                                    <div class="message-content">
                                      <img src="${response.data.senderProfileImg}" alt="Profile Image" width="30" height="30">
                                      <div>
                                        <p class="sender-name">${response.data.senderName}</p>
                                        <p class="message-text">${response.data.message}</p>
                                        <p class="message-time">${new Date(response.data.createdAt).toLocaleString()}</p>
                                      </div>
                                    </div>
                                  `;
            messagesElement.appendChild(li);

            // Scroll to bottom if was already at bottom before fetching new messages or on initial load
            if (shouldScrollToBottom || messagesElement.children.length === 0) {
              //messagesElement.scrollTop = messagesElement.scrollHeight;
              setTimeout(() => {
                messagesElement.scrollTop = messagesElement.scrollHeight;
              }, 0);
            }
          }
        });

        // friend-online event listener
        socket.on("friend-online", (response) => {
          // html 동적 생성
          const item = document.createElement("li");
          item.textContent = `Friend ID: ${response.data.memberId} is online`;
          onlineFriends.appendChild(item);

          // 현재 온라인인 친구 목록 업데이트
          onlineFriendMemberIdList.push(response.data.memberId);
          console.log("current online Friend Member Id List:", onlineFriendMemberIdList);

          // 현재 채팅 중인 (채팅창을 보고있는) memberId와 동일한 경우 상태 텍스트 변경
          console.log("friend-online listener: currentChattingMemberId is.. ", currentChattingMemberId);
          if (currentChattingMemberId === response.data.memberId) {
            console.log("response.data.memberId is..  ", response.data.memberId);

            const chatroomHeader = document.querySelector(".column.chatroom h2");
            const statusElement = chatroomHeader.querySelector("span");
            if (statusElement) {
              statusElement.textContent = "(online)";
              statusElement.classList.remove("offline");
              statusElement.classList.add("online");
            }
          }
        });

        socket.on("member-info", (response) => {
          loginStatus.textContent = "You are Login User, member Id: " + response.data.memberId;

          // 전역변수 초기화
          memberId = response.data.memberId;
        });

        // 현재 온라인인 친구 목록 초기화
        socket.on("init-online-friend-list", (response) => {
          onlineFriendMemberIdList = response.data.onlineFriendMemberIdList;

          // 로그 확인
          console.log("init-online-friend-list event에 대한 listener가 작동합니다.");
          console.log("Online Friend Member ID List:", onlineFriendMemberIdList);
        });

        // friend-offline event listener
        socket.on("friend-offline", (response) => {
          const memberId = response.data.memberId;

          // onlineFriendMemberIdList에서 해당 memberId 제거
          onlineFriendMemberIdList = onlineFriendMemberIdList.filter((id) => id !== memberId);

          console.log(`Friend ID: ${memberId} is offline`);
          console.log("Updated online Friend Member Id List:", onlineFriendMemberIdList);

          // 현재 채팅 중인 memberId와 동일한 경우 상태 텍스트 변경
          if (currentChattingMemberId === memberId) {
            const chatroomHeader = document.querySelector(".column.chatroom h2");
            const statusElement = chatroomHeader.querySelector("span");
            if (statusElement) {
              statusElement.textContent = "(offline)";
              statusElement.classList.remove("online");
              statusElement.classList.add("offline");
            }
          }
        });
      }

      loginButton.addEventListener("click", () => {
        const userId = userIdInput.value;
        if (!userId) {
          alert("Please enter your ID.");
          return;
        }

        fetch("http://localhost:8080/v1/auth/login", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            id: userId,
            loginType: "KAKAO",
          }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.isSuccess && data.result.accessToken) {
              // jwt 토큰 localStorage에 저장
              const jwtToken = data.result.accessToken;
              localStorage.setItem("jwtToken", jwtToken);

              alert("Login successful! Token received.");
              console.log("Using existing socket. Socket ID:", socket.id);

              // 나의 회원 정보 요청해 localStorage에 저장
              fetch("http://localhost:8080/v1/member", {
                headers: {
                  Authorization: `Bearer ${jwtToken}`, // Include JWT token in header
                },
              })
                .then((response) => response.json())
                .then((data) => {
                  if (data.isSuccess && data.result) {
                    localStorage.setItem("profileImg", data.result.profileImg);
                    localStorage.setItem("name", data.result.name);
                  }
                })
                .catch((error) => console.error("Error:", error));

              // 3000 서버로 api 요청(소켓 초기화를 위함)
              fetch("/login", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  Authorization: `Bearer ${jwtToken}`,
                  "Socket-Id": socket.id,
                },
              })
                .then((response) => response.json())
                .then((data) => {
                  console.log(data);
                })
                .catch((error) => console.error("Error:", error));
            } else {
              alert("Login failed.");
            }
          })
          .catch((error) => console.error("Error:", error));
      });

      logoutButton.addEventListener("click", () => {
        // 로그아웃 버튼 클릭 이벤트 추가
        const jwtToken = localStorage.getItem("jwtToken");
        if (!jwtToken) {
          alert("You are not logged in.");
          return;
        }

        // 8080으로 먼저 logout 요청 보내는게 맞지만, 여기서는 일단 3000으로만 보낸다
        fetch("/logout", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${jwtToken}`,
            "Socket-Id": socket.id,
          },
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.isSuccess) {
              alert("Logout successful!");
              localStorage.removeItem("jwtToken");
              // 로그아웃 후 페이지 새로고침 또는 다른 후속 조치
              location.reload();
            } else {
              alert("Logout failed.");
            }
          })
          .catch((error) => console.error("Error:", error));
      });

      fetchChatroomBtn.addEventListener("click", () => {
        const jwtToken = localStorage.getItem("jwtToken");
        if (!jwtToken) {
          console.error("JWT token is missing.");
          return;
        }

        fetch("http://localhost:8080/v1/member/chatroom", {
          headers: {
            Authorization: `Bearer ${jwtToken}`, // Include JWT token in header
          },
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.isSuccess && data.result) {
              // Clear existing chatroom elements
              const chatroomListElement = document.getElementById("chatroomList");
              chatroomListElement.innerHTML = "";

              // Loop through response data to create chatroom list elements
              data.result.forEach((chatroom) => {
                const li = document.createElement("li");
                li.classList.add("chatroom-item");
                li.setAttribute("data-chatroom-uuid", chatroom.uuid); // Add data-chatroom-uuid attribute

                li.innerHTML = `
                                                  <div>
                                                      <img src="${chatroom.targetMemberImg}" alt="Profile Image" width="30" height="30">
                                                  </div>
                                                  <div class="chatroom-info">
                                                      <span>${chatroom.targetMemberName}</span>
                                                      <p>${chatroom.lastMsg}</p>
                                                  </div>
                                                  <div>
                                                      <p>${new Date(chatroom.lastMsgTime).toLocaleString()}</p>
                                                      <p data-new-count>New: ${chatroom.notReadMsgCnt}</p>
                                                      <button class="enter-chatroom-btn" data-chatroom-uuid="${chatroom.uuid}">채팅방 입장</button>
                                                  </div>
                                              `;
                chatroomListElement.appendChild(li);
              });

              // Add event listeners to the "Enter Chatroom" buttons
              const enterChatroomButtons = document.querySelectorAll(".enter-chatroom-btn");
              enterChatroomButtons.forEach((button) => {
                button.addEventListener("click", (event) => {
                  const chatroomUuid = event.target.getAttribute("data-chatroom-uuid");
                  enterChatroom(chatroomUuid);
                });
              });
            } else {
              console.error("Failed to fetch chatroom data.", data.message);
            }
          })
          .catch((error) => {
            console.error("Error fetching chatroom data:", error);
          });
      });

      function enterChatroom(chatroomUuid) {
        console.log(`Entering chatroom with UUID: ${chatroomUuid}`);
        const jwtToken = localStorage.getItem("jwtToken");
        if (!jwtToken) {
          console.error("JWT token is missing.");
          return;
        }

        // Fetch chatroom details to get targetMemberImg and targetMemberName
        fetch(`http://localhost:8080/v1/chat/${chatroomUuid}`, {
          headers: {
            Authorization: `Bearer ${jwtToken}`, // Include JWT token in header
          },
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.isSuccess && data.result) {
              const targetMemberData = data.result;

              // Update chatroom header
              const chatroomHeader = document.querySelector(".column.chatroom h2");

              // Determine status text based on online status
              const isOnline = onlineFriendMemberIdList.includes(targetMemberData.memberId);
              const statusText = isOnline ? "online" : "offline";

              // Create status element with appropriate class
              const statusElement = document.createElement("span");
              statusElement.textContent = `(${statusText})`;
              statusElement.classList.add(isOnline ? "online" : "offline");

              // Update chatroom header with profile image, name, and status element
              chatroomHeader.innerHTML = `<img src="${targetMemberData.memberProfileImg}" alt="Profile Image" width="30" height="30" style="vertical-align: middle;">${targetMemberData.name}`;
              chatroomHeader.appendChild(statusElement);

              // Update the new count to 0
              const chatroomItem = document.querySelector(`.chatroom-item[data-chatroom-uuid="${chatroomUuid}"] p[data-new-count]`);
              if (chatroomItem) {
                chatroomItem.textContent = "New: 0";
              } else {
                console.error(`Could not find chatroom item with UUID ${chatroomUuid} to update new count.`);
              }

              // 현재 보고 있는 채팅방 uuid, 채팅 중인 memberId 업데이트
              currentViewingChatroomUuid = chatroomUuid;
              currentChattingMemberId = targetMemberData.memberId;

              // Fetch chatroom messages
              fetch(`http://localhost:8080/v1/chat/${chatroomUuid}/messages?page=1`, {
                headers: {
                  Authorization: `Bearer ${jwtToken}`, // Include JWT token in header
                },
              })
                .then((response) => response.json())
                .then((data) => {
                  if (data.isSuccess && data.result && data.result.chatMessageDtoList) {
                    // Clear existing messages
                    const messagesElement = document.getElementById("messages");
                    const shouldScrollToBottom = messagesElement.scrollTop === messagesElement.scrollHeight - messagesElement.clientHeight;

                    messagesElement.innerHTML = "";

                    const sortedMessages = data.result.chatMessageDtoList.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));

                    // Loop through response data to create message elements
                    sortedMessages.forEach((message) => {
                      const li = document.createElement("li");
                      li.classList.add("message-item");
                      if (message.mine) {
                        li.classList.add("mine");
                      }
                      li.innerHTML = `
                                    <div class="message-content">
                                      <img src="${message.senderProfileImg}" alt="Profile Image" width="30" height="30">
                                      <div>
                                        <p class="sender-name">${message.senderName}</p>
                                        <p class="message-text">${message.message}</p>
                                        <p class="message-time">${new Date(message.createdAt).toLocaleString()}</p>
                                      </div>
                                    </div>
                                  `;
                      messagesElement.appendChild(li);
                    });

                    // Scroll to bottom if was already at bottom before fetching new messages or on initial load
                    if (shouldScrollToBottom || messagesElement.children.length === 0) {
                      messagesElement.scrollTop = messagesElement.scrollHeight;
                    }
                  } else {
                    console.error("Failed to fetch chatroom messages.", data.message);
                  }
                })
                .catch((error) => {
                  console.error("Error fetching chatroom messages:", error);
                });
            } else {
              console.error("Failed to fetch chatroom details.", chatroomData.message);
            }
          })
          .catch((error) => {
            console.error("Error fetching chatroom details:", error);
          });
      }

      window.addEventListener("load", () => {
        const jwtToken = localStorage.getItem("jwtToken");
        connectSocket(jwtToken);
      });
    </script>
  </body>
</html>
